// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Role {
  id   String @id @default(cuid())
  name String
  isActive Boolean @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  users User[]

  @@map("roles")
}

model User {
  id        String   @id @default(cuid())
  name      String?
  lastname  String?
  phone     String   @unique
  photo     String?
  email     String?
  roleId    String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  addresses            Address[]
  customerReservations Reservation[] @relation("CustomerReservations")
  allyReservations     Reservation[] @relation("AllyReservations")
  payments             Payment[]
  sessions             Session[]
  role                 Role          @relation(fields: [roleId], references: [id])

  @@map("users")
}

model Address {
  id           String   @id @default(cuid())
  address      String
  neighborhood String   @default("")
  label        String?
  city         String
  state        String
  country      String
  extra        String?
  userId       String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  reservations Reservation[]

  @@map("addresses")
}

model Package {
  id          String   @id @default(cuid())
  description String
  hours       Int
  price       Decimal  @db.Decimal(10, 2)
  restriction String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  reservations Reservation[]

  @@map("packages")
}

model Service {
  id          String   @id @default(cuid())
  name        String
  description String
  image       String?
  comingSoon  Boolean  @default(false)
  // price       Decimal       @db.Decimal(10, 2)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  reservations Reservation[]

  @@map("services")
}

model Reservation {
  id        String            @id @default(cuid())
  type      ReservationType   @default(home)
  date      DateTime          @db.Timestamptz(3)
  status    ReservationStatus @default(pending)
  userId    String
  serviceId String
  addressId String
  packageId String
  couponId  String?
  allyId    String?
  createdAt DateTime          @default(now())
  updatedAt DateTime          @updatedAt

  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade, name: "CustomerReservations")
  service  Service   @relation(fields: [serviceId], references: [id])
  address  Address   @relation(fields: [addressId], references: [id])
  package  Package   @relation(fields: [packageId], references: [id])
  coupon   Coupon?   @relation(fields: [couponId], references: [id])
  ally     User?     @relation(fields: [allyId], references: [id], onDelete: SetNull, name: "AllyReservations")
  payments Payment[]

  @@map("reservations")
}

model Payment {
  id                  String   @id @default(cuid())
  amount              Decimal  @db.Decimal(10, 2)
  transactionId       String   @unique
  transactionResponse String?  @db.Text
  paymentMethod       String
  userId              String
  reservationId       String
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  reservation Reservation @relation(fields: [reservationId], references: [id], onDelete: Cascade)

  @@map("payments")
}

model Coupon {
  id                        String       @id @default(cuid())
  discountCode              String       @unique
  discountAmount            Decimal      @db.Decimal(10, 2)
  discountType              DiscountType @default(percentage)
  usageLimit                Int
  isActive                  Boolean      @default(true)
  isFirstReservationDiscount Boolean      @default(false)
  expiresAt                 DateTime
  createdAt                 DateTime     @default(now())
  updatedAt                 DateTime     @updatedAt

  reservations Reservation[]

  @@map("coupons")
}

enum ReservationType {
  home
  office
}

enum ReservationStatus {
  pending
  cancelled
  completed
}

enum DiscountType {
  percentage
  fixed
}

model Session {
  id               String   @id @default(cuid())
  userId           String
  accessToken      String   @unique
  refreshToken     String   @unique
  expiresAt        DateTime
  refreshExpiresAt DateTime
  revoked          Boolean  @default(false)
  deviceInfo       String?
  ipAddress        String?
  lastUsedAt       DateTime @default(now())
  createdAt        DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([accessToken])
  @@index([refreshToken])
  @@index([userId, revoked])
  @@map("sessions")
}
